<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Libras Bridge - Tradutor em Tempo Real</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&family=Poppins:wght@300..800&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=2">

  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <style>
    /* Estilos espec√≠ficos do tradutor */
    .video-area {
      position: relative;
      background: #000;
      height: 520px;
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      overflow: hidden;
    }

    #video-canvas {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none;
    }

    #video-canvas.active {
      display: block;
    }

    .video-placeholder {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #fff;
      font-family: "Fredoka";
      font-size: 26px;
      opacity: 0.9;
      z-index: 1;
    }

    .video-placeholder.hidden {
      display: none;
    }

    .tradutor-controls {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      justify-content: center;
      align-items: center;
    }

    .control-btn {
      padding: 14px 32px;
      border-radius: 50px;
      border: none;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Poppins', sans-serif;
    }

    .control-btn.start {
      background: var(--teal);
      color: white;
    }

    .control-btn.start:hover {
      background: var(--accent);
      transform: translateY(-2px);
    }

    .control-btn.stop {
      background: #e74c3c;
      color: white;
    }

    .control-btn.stop:hover {
      background: #c0392b;
    }

    .control-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .translation-panel {
      margin-top: 30px;
      background: rgba(255, 255, 255, 0.95);
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .translation-title {
      font-family: 'Fredoka';
      font-size: 24px;
      color: var(--teal);
      margin-bottom: 15px;
    }

    .translation-output {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      min-height: 80px;
      font-size: 20px;
      color: var(--text-dark);
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--mint-200);
    }

    .translation-output.empty {
      color: var(--muted);
      font-weight: 400;
      font-size: 16px;
    }

    .history-panel {
      margin-top: 20px;
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .history-title {
      font-family: 'Fredoka';
      font-size: 18px;
      color: var(--teal);
      margin-bottom: 10px;
    }

    .history-item {
      padding: 8px 12px;
      background: var(--mint-200);
      margin-bottom: 8px;
      border-radius: 8px;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-time {
      color: var(--muted);
      font-size: 12px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--muted);
      margin-top: 15px;
      justify-content: center;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #95a5a6;
    }

    .status-dot.connected {
      background: #2ecc71;
      animation: pulse 2s infinite;
    }

    .status-dot.detecting {
      background: #f39c12;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .confidence-bar {
      margin-top: 15px;
      background: #ecf0f1;
      height: 8px;
      border-radius: 10px;
      overflow: hidden;
    }

    .confidence-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--teal));
      transition: width 0.3s;
      width: 0%;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <!-- Header / Nav -->
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <img src="{{ url_for('static', filename='logolibras.png') }}" alt="Libras Bridge logo" class="logo">
      </div>
      <nav class="main-nav" aria-label="Menu principal">
        <a href="#explorar" class="nav-link">explorar</a>
        <a href="#contato" class="nav-link">contato</a>
        <button id="language" class="lang-btn" aria-label="Mudar idioma">Portugu√™s - Brasil</button>
      </nav>
    </div>
  </header>

  <!-- Hero INICIO-->
  <main>
    <section id="home" class="hero">
      <div class="container hero-inner">
        <div class="hero-left">
          <h1 class="hero-title">
            Traduzindo mais que palavras, <strong>constru√≠mos pontes entre pessoas</strong>, <em>hist√≥rias e culturas.</em>
          </h1>
          <p class="hero-sub">
            Acreditamos que a comunica√ß√£o √© um direito de todos e aqui, ela tamb√©m fala em Libras, com respeito, clareza e inclus√£o.
          </p>

          <div class="hero-actions">
            <a href="#about" class="btn primary" id="btn-sobre">sobre n√≥s</a>
            <a href="#tradutor" class="btn ghost" id="btn-tradutor">Acessar o tradutor</a>
          </div>
        </div>

        <div class="hero-right" aria-hidden="true">
          <img src="{{ url_for('static', filename='computadorlibras.png') }}" alt="" class="hero-image">
        </div>
      </div>

      <!-- decorative wave -->
      <svg class="hero-wave" viewBox="0 0 1440 120" preserveAspectRatio="none" aria-hidden="true">
        <path d="M0,40 C220,120 440,0 720,40 C1000,80 1220,20 1440,60 L1440 120 L0 120 Z"/>
      </svg>
    </section>

    <!-- About / Quem somos -->
    <section id="about" class="section about">
      <div class="container about-inner">
        <div class="about-left">
          <img src="{{ url_for('static', filename='logolibras.png') }}" alt="Logo ponte Libras Bridge" class="about-logo">
        </div>

        <div class="about-right">
          <h2 class="section-title">Libras Bridge</h2>
          <p class="lead">
            A comunica√ß√£o entre surdos e ouvintes ainda enfrenta barreiras, dificultando a inclus√£o social. O Libras Bridge busca superar esse desafio ao reconhecer Libras em tempo real e convert√™-la em texto e voz, promovendo acessibilidade e igualdade na comunica√ß√£o.
          </p>
        </div>
      </div>
    </section>

    <!-- Quem somos long -->
    <section class="section quem" aria-labelledby="quem-title">
      <div class="container text-center">
        <h3 id="quem-title" class="big-title">Quem somos</h3>

        <p class="quem-text">
          Somos uma equipe comprometida em promover a inclus√£o digital e social por meio da tecnologia. Desenvolvemos o Libras Bridge, uma plataforma web que reconhece sinais em Libras via c√¢mera e os traduz em texto e voz em tempo real.
        </p>
      </div>
    </section>

    <!-- TIME -->
    <section class="section team">
      <div class="container">
        <h4 class="team-title">Nossa equipe</h4>

        <div class="team-grid">
          <div class="member">
            <div class="avatar-bg"><img src="{{ url_for('static', filename='assets/antonio.png') }}" alt="Ant√¥nio"></div>
            <p class="name">Ant√¥nio</p>
          </div>
          <div class="member">
            <div class="avatar-bg"><img src="{{ url_for('static', filename='assets/julia.png') }}" alt="Julia" style="transform: scale(1.15); transform-origin: bottom center;"></div>
            <p class="name">Julia</p>
          </div>
          <div class="member">
            <div class="avatar-bg"><img src="{{ url_for('static', filename='assets/larissa.png') }}" alt="Larissa" style="transform: scale(1.15); transform-origin: bottom center;"></div>
            <p class="name">Larissa</p>
          </div>
          <div class="member">
            <div class="avatar-bg"><img src="{{ url_for('static', filename='assets/maria.png') }}" alt="Maria" style="width: 190px !important; bottom: -40px !important; max-width: none !important;"></div>
            <p class="name">Maria</p>
          </div>
          <div class="member">
            <div class="avatar-bg"><img src="{{ url_for('static', filename='assets/lara.png') }}" alt="Lara" style="transform: scale(1.45); transform-origin: bottom center;"></div>
            <p class="name">Lara</p>
          </div>
        </div>
      </div>
    </section>

    <!-- OBJETIVO-->
    <section class="section mission">
      <div class="container text-center">
        <h2 class="mission-title">Conectamos pessoas, eliminamos barreiras. Saiba mais sobre nossa miss√£o!</h2>
        <p class="mission-text">
          Nosso tradutor consiste em uma ferramenta inclusiva e √°gil; a partir dela √© poss√≠vel traduzir gestos em Libras e assim melhorar a comunica√ß√£o entre uma pessoa ouvinte e n√£o ouvinte.
        </p>
      </div>
    </section>

    <!-- Translator / TRADUTOR -->
    <section id="tradutor" class="section tradutor">
      <div class="container tradutor-inner">
        <h2 class="trans-title">Fa√ßa o gesto para transcrever...</h2>
        
        <div class="video-area" role="region" aria-label="√Årea do tradutor">
          <!-- Video Element para mostrar webcam local -->
          <video id="video-preview" autoplay playsinline muted style="width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); display: none;"></video>
          
          <!-- Canvas oculto para capturar frames -->
          <canvas id="frame-canvas" style="display: none;"></canvas>
          
          <div id="video-placeholder" class="video-placeholder">
            <div>üì∑</div>
            <div>Clique em "Iniciar C√¢mera" para come√ßar</div>
          </div>
        </div>

        <div class="tradutor-controls">
          <button id="start-btn" class="control-btn start">
            üé• Iniciar C√¢mera
          </button>
          <button id="stop-btn" class="control-btn stop" disabled>
            ‚èπÔ∏è Parar C√¢mera
          </button>
        </div>

        <div class="status-indicator">
          <span class="status-dot" id="status-dot"></span>
          <span id="status-text">Desconectado</span>
        </div>

        <div class="translation-panel">
          <div class="translation-title">Tradu√ß√£o Atual:</div>
          <div class="translation-output empty" id="translation-output">
            Aguardando detec√ß√£o de gestos...
          </div>
          <div class="confidence-bar">
            <div class="confidence-fill" id="confidence-fill"></div>
          </div>
        </div>

        <div class="history-panel">
          <div class="history-title">üìã Hist√≥rico de Tradu√ß√µes:</div>
          <div id="history-list">
            <div style="color: var(--muted); text-align: center; padding: 20px;">
              Nenhuma tradu√ß√£o ainda
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- FOOTER -->
    <footer id="contato" class="site-footer">
      <div class="container footer-grid">
        <div class="footer-col">
          <h5>Home</h5>
          <ul>
            <li><a href="#home">Home</a></li>
            <li><a href="#about">Sobre</a></li>
            <li><a href="#tradutor">Explorar</a></li>
            <li><a href="#contato">Contato</a></li>
          </ul>
        </div>

        <div class="footer-col">
          <h5>Solu√ß√µes</h5>
          <p>Plataforma de tradu√ß√£o em tempo real e ferramentas de acessibilidade.</p>
        </div>

        <div class="footer-col">
          <h5>Ajuda</h5>
          <p>Central de ajuda</p>
        </div>

        <div class="footer-col socials">
          <h5>Redes sociais</h5>
          <p><span class="icon">üìû</span> (12) 9 9999-9999</p>
          <p><span class="icon">üì∑</span> libras.bridge</p>
          <p><span class="icon">üìò</span> (12) 9 9999-9999</p>
        </div>
      </div>

      <div class="footer-bottom">
        <div class="container footer-bottom-inner">
          <img src="{{ url_for('static', filename='logolibras.png') }}" alt="Libras Bridge logo small" class="logo-small">
          <div class="lang-floating">Portugu√™s - Brasil</div>
        </div>
      </div>
    </footer>

  </main>

  <script src="{{ url_for('static', filename='script.js') }}"></script>
  
  <script>
    // WebSocket Integration
    const socket = io();
    let isStreaming = false;
    let historyCount = 0;
    let localStream = null;

    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    // videoPreview √© o elemento <video>
    const videoPreview = document.getElementById('video-preview');
    // frameCanvas √© o elemento <canvas> para captura
    const frameCanvas = document.getElementById('frame-canvas');
    const ctx = frameCanvas.getContext('2d');

    const placeholder = document.getElementById('video-placeholder');
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const translationOutput = document.getElementById('translation-output');
    const confidenceFill = document.getElementById('confidence-fill');
    const historyList = document.getElementById('history-list');

    // Socket Events
    socket.on('connect', () => {
      console.log('Conectado ao servidor');
      statusDot.classList.add('connected');
      statusText.textContent = 'Conectado';
    });

    socket.on('disconnect', () => {
      console.log('Desconectado do servidor');
      statusDot.classList.remove('connected', 'detecting');
      statusText.textContent = 'Desconectado';
      stopCamera();
    });

    socket.on('frame_processed', (data) => {
      // Atualizar status
      if (data.hand_detected) {
        statusDot.classList.add('detecting');
        statusText.textContent = 'Detectando m√£o...';
      } else {
        statusDot.classList.remove('detecting');
        statusText.textContent = 'Aguardando m√£o...';
      }

      // Atualizar tradu√ß√£o
      if (data.gesto && data.confianca > 0) {
        translationOutput.textContent = data.gesto.toUpperCase();
        translationOutput.classList.remove('empty');
        confidenceFill.style.width = data.confianca + '%';
        
        // Adicionar ao hist√≥rico
        addToHistory(data.gesto, data.confianca);
      }
    });

    // Controls
    startBtn.addEventListener('click', async () => {
      startBtn.disabled = true;
      statusText.textContent = 'Solicitando acesso √† c√¢mera...';
      
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: "user"
          } 
        });
        
        localStream = stream;
        videoPreview.srcObject = stream;
        videoPreview.onloadedmetadata = () => {
            videoPreview.play();
            startStreaming();
        };
        
        statusText.textContent = 'C√¢mera iniciada!';
        stopBtn.disabled = false;
        
        // Notificar servidor para limpar estado
        socket.emit('start_camera');

      } catch (err) {
        console.error("Erro ao acessar c√¢mera:", err);
        alert('N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes do navegador.');
        statusText.textContent = 'Erro de acesso √† c√¢mera';
        startBtn.disabled = false;
      }
    });

    stopBtn.addEventListener('click', () => {
      stopCamera();
    });

    function startStreaming() {
      isStreaming = true;
      videoPreview.style.display = 'block';
      placeholder.classList.add('hidden');
      startBtn.disabled = true;
      stopBtn.disabled = false;
      
      // Enviar frames
      sendFrame();
    }

    function stopCamera() {
      isStreaming = false;
      
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      
      videoPreview.style.display = 'none';
      videoPreview.srcObject = null;
      placeholder.classList.remove('hidden');
      
      startBtn.disabled = false;
      stopBtn.disabled = true;
      
      translationOutput.textContent = 'Aguardando detec√ß√£o de gestos...';
      translationOutput.classList.add('empty');
      confidenceFill.style.width = '0%';
      statusDot.classList.remove('detecting');
      statusText.textContent = 'C√¢mera parada';
      
      socket.emit('stop_camera');
    }

    function sendFrame() {
      if (!isStreaming) return;

      if (videoPreview.readyState === videoPreview.HAVE_ENOUGH_DATA) {
          // Fixar tamanho do canvas para 320x240 para otimizar envio
          const targetWidth = 320;
          const targetHeight = 240;

          if (frameCanvas.width !== targetWidth || frameCanvas.height !== targetHeight) {
              frameCanvas.width = targetWidth;
              frameCanvas.height = targetHeight;
          }
          
          // Desenhar redimensionado
          ctx.drawImage(videoPreview, 0, 0, targetWidth, targetHeight);
          
          // Converter para base64 e enviar
          // Reduzir qualidade para 0.5 para economizar banda
          const dataURL = frameCanvas.toDataURL('image/jpeg', 0.5);
          const base64 = dataURL.split(',')[1];
          
          socket.emit('process_frame_web', { image: base64 });
      }
      
      // Limitar FPS de envio para n√£o sobrecarregar servidor (ex: 10 FPS = 100ms)
      setTimeout(sendFrame, 100); 
    }

    let lastGesto = null;
    function addToHistory(gesto, confianca) {
      // Evitar duplicatas consecutivas
      if (gesto === lastGesto) return;
      lastGesto = gesto;

      const now = new Date();
      const time = now.toLocaleTimeString('pt-BR');
      
      if (historyCount === 0) {
        historyList.innerHTML = '';
      }
      
      const item = document.createElement('div');
      item.className = 'history-item';
      item.innerHTML = `
        <span><strong>${gesto.toUpperCase()}</strong></span>
        <span class="history-time">${time}</span>
      `;
      
      historyList.insertBefore(item, historyList.firstChild);
      historyCount++;
      
      // Manter apenas √∫ltimos 10
      if (historyCount > 10) {
        historyList.removeChild(historyList.lastChild);
      }
    }
  </script>
</body>
</html>